name: Build-Samsung-S24-Kernel-AXK4
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          swap-size-mb: 16384

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm

      - name: Setup KernelSU and Patch Source
        run: |
          cd kernel_platform/common
          curl -LSs "https://raw.githubusercontent.com" | bash -
          rm -f android/abi_gki_protected_exports_*
          DEFCONFIG="arch/arm64/configs/pineapple_gki_defconfig"
          echo "CONFIG_KSU=y" >> $DEFCONFIG
          echo "CONFIG_OVERLAY_FS=y" >> $DEFCONFIG
          sed -i 's/CONFIG_RKP_KDP=y/CONFIG_RKP_KDP=n/g' $DEFCONFIG
          sed -i 's/CONFIG_RKP_NS_PROT=y/CONFIG_RKP_NS_PROT=n/g' $DEFCONFIG
          sed -i 's/CONFIG_SECURITY_DEFEX=y/CONFIG_SECURITY_DEFEX=n/g' $DEFCONFIG
          sed -i 's/CONFIG_SECURITY_DSMS=y/CONFIG_SECURITY_DSMS=n/g' $DEFCONFIG
          sed -i 's/CONFIG_KNOX_KAP=y/CONFIG_KNOX_KAP=n/g' $DEFCONFIG
          sed -i 's/CONFIG_FIVE=y/CONFIG_FIVE=n/g' $DEFCONFIG
          sed -i 's/CONFIG_LTO_CLANG_THIN=y/CONFIG_LTO_NONE=y/g' $DEFCONFIG
          sed -i 's/CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_NONE=y/g' $DEFCONFIG
          echo "CONFIG_LTO_NONE=y" >> $DEFCONFIG
          sed -i 's/CONFIG_MODULE_SIG_FORCE=y/n/g' $DEFCONFIG
          echo "CONFIG_MODULE_SIG=n" >> $DEFCONFIG

      - name: Build Kernel
        run: |
          chmod +x build_kernel_GKI.sh
          chmod -R +x kernel_platform/tools/
          chmod -R +x kernel_platform/build/
          export BAZEL_RAM=6144
          export BAZEL_JOBS=2
          ./build_kernel_GKI.sh

      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: S24-AXK4-KSU-Kernel
          path: out/**/arch/arm64/boot/Image
