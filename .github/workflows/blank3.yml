name: Blank3
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read

    steps:
      - name: Checkout Script
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          swap-size-mb: 16384

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm python3-pip unzip p7zip-full

      - name: Download and Extract Source
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "æ­£åœ¨ä¸‹è½½æºç ..."
          gh release download kernel --repo ${{ github.repository }} --pattern 'Kernel.tar.gz' --clobber
          
          echo "æ­£åœ¨è§£åŽ‹æºç ..."
          mkdir -p kernel_source
          if ls *.zip 1> /dev/null 2>&1; then
            unzip -q *.zip -d kernel_source/
          elif ls *.tar.gz 1> /dev/null 2>&1; then
            tar -zxf *.tar.gz -C kernel_source/
          fi
          
          if [ -d "kernel_source/kernel_source" ]; then
            mv kernel_source/kernel_source/* kernel_source/
          fi

      - name: Download and Setup Official Toolchain
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 1. ç¡®å®šå·¥ä½œæ ¹ç›®å½•
          PROJECT_ROOT=$(find $GITHUB_WORKSPACE/kernel_source -name "kernel_platform" -printf '%h\n' | head -n 1)
          cd "$PROJECT_ROOT"

          echo "æ­£åœ¨ä¸‹è½½å·¥å…·é“¾åˆ†å·..."
          gh release download S24_Tools --repo ${{ github.repository }} --pattern 'toolchain.tar.tar.*' --clobber

          echo "æ­£åœ¨åˆå¹¶å¹¶æå–åˆ†å· (7z)..."
          # 7z ä¼šç›´æŽ¥ä»Ž .001 æå–å‡ºé‡Œé¢çš„åŽ‹ç¼©åŒ…
          7z x toolchain.tar.tar.001 -y
          
          # ã€å…³é”®è°ƒè¯•æ­¥éª¤ã€‘åˆ—å‡ºå½“å‰æ–‡ä»¶ï¼Œçœ‹çœ‹ 7z åˆ°åº•è§£åŽ‹å‡ºäº†ä»€ä¹ˆ
          echo "æ£€æŸ¥å½“å‰ç›®å½•ä¸‹æ–‡ä»¶ï¼š"
          ls -lh
          
          # 2. ç‰©ç†å®šä½è§£åŽ‹å‡ºæ¥çš„åŽ‹ç¼©åŒ… (è‡ªåŠ¨å¤„ç†å‘½åä¸ä¸€è‡´)
          GZ_FILE=$(ls *.tar.gz 2>/dev/null | head -n 1)
          if [ -z "$GZ_FILE" ]; then
            echo "é”™è¯¯ï¼šæœªå‘çŽ° .tar.gz æ–‡ä»¶ï¼Œå°è¯•æŸ¥æ‰¾ .tar"
            TAR_FILE=$(ls *.tar 2>/dev/null | head -n 1)
          else
            echo "å‘çŽ°åŽ‹ç¼©åŒ…: $GZ_FILEï¼Œæ­£åœ¨è§£åŽ‹ç¼©ä¸º .tar..."
            # ä½¿ç”¨ gunzip ä¿æŒæ–‡ä»¶åä¸€è‡´æ€§ï¼Œè¿™æ ·æ›´èŠ‚çœç©ºé—´ä¸”ç¨³å®š
            gunzip -f "$GZ_FILE"
            TAR_FILE=$(ls *.tar 2>/dev/null | head -n 1)
          fi

          if [ -z "$TAR_FILE" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•å®šä½åˆ°ä»»ä½• .tar æ–‡ä»¶ï¼"
            ls -R
            exit 1
          fi

          echo "æœ€ç»ˆè§£åŽ‹ $TAR_FILE åˆ° prebuilts..."
          mkdir -p kernel_platform/prebuilts
          # æ‰§è¡Œæœ€ç»ˆè§£åŽ‹
          tar -xf "$TAR_FILE" -C kernel_platform/prebuilts/ --strip-components=1

          echo "æ¸…ç†ä¸´æ—¶å¤§æ–‡ä»¶..."
          rm -f toolchain.tar.tar.*
          rm -f *.tar
          
          echo "å·¥å…·é“¾å°±ä½ï¼éªŒè¯è·¯å¾„ï¼š"
          ls -F kernel_platform/prebuilts/ | head -n 10


      - name: Setup KernelSU and Security Patches
        run: |
          COMMON_PATH=$(find $GITHUB_WORKSPACE/kernel_source -name "common" -type d | grep "kernel_platform/common" | head -n 1)
          cd "$COMMON_PATH"

          # 1. é›†æˆ KernelSU
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

          # 2. ä¿®æ”¹ Defconfig 
          DEFCONFIG="arch/arm64/configs/gki_defconfig"
          ./scripts/config --file $DEFCONFIG \
            -d UH \
            -d FIVE \
            -d PROCA \
            -d PROCA_S_OS \
            -d PROCA_CERTIFICATES_DB \
            -d SECURITY_DEFEX \
            -d KNOX_NCM \
            -d KNOX_KNOX_NCM \
            -d SECURITY_DSMS \
            -d SECURITY_KUMIHO \
            -d MODULE_SIG 
          
          # å¼€å¯KernelSU
          echo "CONFIG_KSU=y" >> $DEFCONFIG
          # Littlenine æåˆ°çš„å…¶ä»–å¹²æ‰°é¡¹ æºç é‡Œæ²¡æœ‰ æ‰‹åŠ¨åŠ ä¸Š
          echo "CONFIG_INTEGRITY=n" >> $DEFCONFIG
          # é‡è¦ï¼šç¦ç”¨ TRIM_UNUSED_KSYMS (ç¡®ä¿ KSU èƒ½æ‰¾åˆ°ç¬¦å·)
          echo "CONFIG_TRIM_UNUSED_KSYMS=n" >> $DEFCONFIG
          

          # ç‰©ç†åˆ é™¤ ABI ä¿æŠ¤æ–‡ä»¶
          rm -f android/abi_gki_protected_exports_*







      - name: Build Kernel
        run: |
          # 1. è‡ªåŠ¨å®šä½é¡¹ç›®æ ¹ç›®å½•
          REAL_PLATFORM=$(find "$GITHUB_WORKSPACE" -name "kernel_platform" -type d -print -quit)
          PROJECT_ROOT=$(dirname "$REAL_PLATFORM")
          cd "$PROJECT_ROOT"
          echo "é¡¹ç›®æ ¹ç›®å½•: $(pwd)"

          # 2. è®¾ç½®å¹¶å¯¼å‡º 2026 æ ¸å¿ƒçŽ¯å¢ƒå˜é‡ (ç§»æ¤è‡ª build_kernel_GKI.sh)
          export BUILD_TARGET=e1q_chn_openx
          export MODEL=$(echo $BUILD_TARGET | cut -d'_' -f1)
          export CHIPSET_NAME=pineapple
          export TARGET_PRODUCT=gki
          export TARGET_BOARD_PLATFORM=gki
          export VENDOR_NAME=sec
          export ANDROID_BUILD_TOP=$(pwd)
          
          # ä¿®æ­£ OUT_DIR è·¯å¾„é‡å¤é—®é¢˜ï¼Œå¹¶è®¾ç½®ä¸ºç»å¯¹è·¯å¾„
          export ANDROID_PRODUCT_OUT="${ANDROID_BUILD_TOP}/out/target/product/${MODEL}"
          export OUT_DIR="${ANDROID_BUILD_TOP}/out/msm-kernel-${CHIPSET_NAME}-${TARGET_PRODUCT}"
          
          # æ ¸å¿ƒä¿æŠ¤å˜é‡ï¼šé˜²æ­¢ KernelSU é…ç½®è¢«æŠ¹é™¤
          export RECOMPILE_KERNEL=1
          export SKIP_MRPROPER=1
          export STOP_SHIP_CHECKS=1

          # 3. é©±åŠ¨æ¨¡å—è·¯å¾„ä¿®å¤ (ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œé˜²æ­¢ cd åŽå¤±æ•ˆ)
          export KBUILD_EXT_MODULES=" \
            ${ANDROID_BUILD_TOP}/vendor/qcom/opensource/display-drivers/msm \
            ${ANDROID_BUILD_TOP}/vendor/qcom/opensource/camera-kernel \
            ${ANDROID_BUILD_TOP}/vendor/qcom/opensource/audio-kernel \
            ${ANDROID_BUILD_TOP}/vendor/qcom/opensource/dsp-kernel"

          # 4. é¢„åˆ›å»ºè¾“å‡ºç›®å½• (è§£å†³ mktemp æŠ¥é”™)
          mkdir -p "$ANDROID_PRODUCT_OUT"
          mkdir -p "$OUT_DIR"

          # 5. ä¿®å¤å®˜æ–¹å·¥å…·é“¾ Python çŽ¯å¢ƒ
          PY3_DIR="kernel_platform/prebuilts/build-tools/path/linux-x86"
          mkdir -p "$PY3_DIR"
          ln -sf $(which python3) "$PY3_DIR/python3"
          export PATH=$PWD/kernel_platform/prebuilts/bazel/linux-x86_64:$PATH
          export PATH=$PWD/kernel_platform/prebuilts/build-tools/path/linux-x86:$PATH
          
          # 6. ç‰©ç†è·¯å¾„å¯¹é½ï¼šç¡®ä¿ kernel_platform å†…éƒ¨èƒ½æ‰¾åˆ° vendor ç¬¦å·
          # è§£å†³ awk: can't open file .../gki_system_dlkm_modules æŠ¥é”™
          if [ -d "vendor" ]; then
            ln -sf "$(pwd)/vendor" "kernel_platform/vendor"
            echo "âœ… å·²å®Œæˆ vendor ç‰©ç†è·¯å¾„å¯¹é½"
          fi
          if [ -d "msm-kernel" ]; then
            ln -sf "$(pwd)/msm-kernel" "kernel_platform/msm-kernel"
          fi

          # 7. ææƒ
          chmod -R +x kernel_platform/prebuilts/
          chmod +x kernel_platform/build/android/prepare_vendor.sh

          # 8. æ‰§è¡Œæž„å»ºé€»è¾‘ (å¸¦å›žé€€æ–¹æ¡ˆ)
          echo "ðŸš€ å¯åŠ¨æž„å»ºæµç¨‹..."
          # ä¼˜å…ˆå°è¯•ä¸‰æ˜Ÿå®˜æ–¹ prepare_vendor æµç¨‹ (å¸¦ä¸Š SKIP_MRPROPER ä¿æŠ¤é…ç½®)
          ./kernel_platform/build/android/prepare_vendor.sh ${CHIPSET_NAME} gki 2>&1 | tee -a build.log || \
          (echo "âš ï¸ prepare_vendor å¤±è´¥ï¼Œå°è¯•æ ‡å‡† build.sh æž„å»º..." && \
           cd kernel_platform && \
           ./build/build.sh 2>&1 | tee -a ../build.log)







      - name: Upload Kernel Output
        uses: actions/upload-artifact@v4
        with:
          name: S24-Kernel-$(date +%Y%m%d)
          path: |
            kernel_source/out/**/boot/Image
            kernel_source/out/**/dist/Image
            kernel_source/out/**/*.ko
