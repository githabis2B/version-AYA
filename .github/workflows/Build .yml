name: s24
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read  # 允许读取 Release

    steps:
      - name: Checkout Script
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          swap-size-mb: 16384

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm python3-pip unzip

      - name: Download and Extract Source
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "正在下载源码..."
          # 下载仓库中所有的压缩包（自动识别 .zip 或 .tar.gz）
          gh release download --repo ${{ github.repository }} --pattern '*'
          
          echo "正在解压..."
          mkdir -p kernel_source
          # 自动根据后缀名解压
          if ls *.zip 1> /dev/null 2>&1; then
            unzip -q *.zip -d kernel_source/
          elif ls *.tar.gz 1> /dev/null 2>&1; then
            tar -zxf *.tar.gz -C kernel_source/
          fi
          
          # 检查解压后的层级，确保 kernel_platform 在根部
          if [ -d "kernel_source/kernel_source" ]; then
            mv kernel_source/kernel_source/* kernel_source/
          fi
          ls -F kernel_source/

      - name: Setup KernelSU
        run: |
          # 自动递归寻找 common 目录
          COMMON_PATH=$(find $GITHUB_WORKSPACE/kernel_source -name "common" -type d | grep "kernel_platform/common" | head -n 1)
          if [ -z "$COMMON_PATH" ]; then echo "错误：源码解压后未找到 common 目录"; exit 1; fi
          echo "COMMON_DIR=$COMMON_PATH" >> $GITHUB_ENV
          
          cd "$COMMON_PATH"
          # 补全 KernelSU 官方脚本地址
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
          
          # 修改配置以绕过三星 S24 的 RKP/KDP 检查（2026 关键点）
          DEFCONFIG="arch/arm64/configs/gki_defconfig"
          rm -f android/abi_gki_protected_exports_*
          
          echo "CONFIG_KSU=y" >> $DEFCONFIG
          echo "CONFIG_OVERLAY_FS=y" >> $DEFCONFIG
          sed -i 's/CONFIG_RKP_KDP=y/CONFIG_RKP_KDP=n/g' $DEFCONFIG
          sed -i 's/CONFIG_RKP_NS_PROT=y/CONFIG_RKP_NS_PROT=n/g' $DEFCONFIG
          sed -i 's/CONFIG_KNOX_KAP=y/CONFIG_KNOX_KAP=n/g' $DEFCONFIG
          # 强制 LTO 为 NONE 以防 GitHub 虚拟机内存溢出
          sed -i 's/CONFIG_LTO_CLANG_THIN=y/CONFIG_LTO_NONE=y/g' $DEFCONFIG
          sed -i 's/CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_NONE=y/g' $DEFCONFIG
          echo "CONFIG_LTO_NONE=y" >> $DEFCONFIG

      - name: Build Kernel (Follow README)
        run: |
          # 1. 进入源码根目录
          BUILD_ROOT=$(find $GITHUB_WORKSPACE/kernel_source -name "kernel_platform" -printf '%h\n' | head -n 1)
          cd "$BUILD_ROOT"

          # 2. 补全工具链 (README 指定路径)
          mkdir -p kernel_platform/prebuilts/clang/host/linux-x86/clang-r487703
          mkdir -p kernel_platform/prebuilts/bazel/linux-x86_64
          
          # 下载 Bazel
          curl -Lo kernel_platform/prebuilts/bazel/linux-x86_64/bazel https://github.com
          chmod +x kernel_platform/prebuilts/bazel/linux-x86_64/bazel
          
          # 下载 Clang (S24 必须使用 r487703)
          curl -Lo clang.tar.gz https://android.googlesource.com
          tar -C kernel_platform/prebuilts/clang/host/linux-x86/clang-r487703 -zxf clang.tar.gz

          # 3. 设置 README 要求的所有环境变量
          export BUILD_TARGET=e1q_chn_openx
          export MODEL=$(echo ${BUILD_TARGET} | cut -d'_' -f1)
          export PROJECT_NAME=${MODEL}
          export REGION=$(echo ${BUILD_TARGET} | cut -d'_' -f2)
          export CARRIER=$(echo ${BUILD_TARGET} | cut -d'_' -f3)
          export TARGET_BUILD_VARIANT=user
          export CHIPSET_NAME=pineapple
          export ANDROID_BUILD_TOP=$(pwd)
          export TARGET_PRODUCT=gki
          export TARGET_BOARD_PLATFORM=gki
          
          # 修正输出路径
          export ANDROID_PRODUCT_OUT=${ANDROID_BUILD_TOP}/out/target/product/${MODEL}
          export OUT_DIR=${ANDROID_BUILD_TOP}/out/msm-kernel-${CHIPSET_NAME}-${TARGET_PRODUCT}
          
          # 4. 权限与修复
          chmod +x kernel_platform/build/android/prepare_vendor.sh
          # 修复 python 软链接 (bazel 运行必需)
          mkdir -p kernel_platform/prebuilts/build-tools/path/linux-x86
          ln -sf $(which python3) kernel_platform/prebuilts/build-tools/path/linux-x86/python3

          # 5. 触发构建 (README 核心命令)
          echo "根据 README 启动 prepare_vendor.sh..."
          RECOMPILE_KERNEL=1 ./kernel_platform/build/android/prepare_vendor.sh sec ${TARGET_PRODUCT}

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: S24-Kernel-Output
          path: |
            kernel_source/out/**/boot/Image
            kernel_source/out/**/*.ko

      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: S24-KSU-Kernel-$(date +%Y%m%d)
          path: |
            kernel_source/out/**/dist/Image
            kernel_source/out/**/dist/*.ko
