name: s24
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          swap-size-mb: 16384

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm python3-pip

      - name: Setup KernelSU and Patch Source
        run: |
          # 核心修复 1：进入正确的路径
          cd kernel_source/kernel_platform/common
          
          # 核心修复 2：修正 KernelSU 注入脚本链接 (2026年推荐 KSU-Next)
          curl -LSs "https://raw.githubusercontent.com" | bash -
          
          # 3. 物理删除 ABI 限制
          rm -f android/abi_gki_protected_exports_*
          
          # 核心修复 3：S24 属于 pineapple 平台，修正 defconfig 逻辑
          # 优先修改 gki_defconfig，这是 GKI 编译的基准
          DEFCONFIG="arch/arm64/configs/gki_defconfig"
          
          echo "CONFIG_KSU=y" >> $DEFCONFIG
          echo "CONFIG_OVERLAY_FS=y" >> $DEFCONFIG
          # 禁用三星 RKP 和 Knox 安全检查
          sed -i 's/CONFIG_RKP_KDP=y/CONFIG_RKP_KDP=n/g' $DEFCONFIG
          sed -i 's/CONFIG_RKP_NS_PROT=y/CONFIG_RKP_NS_PROT=n/g' $DEFCONFIG
          sed -i 's/CONFIG_KNOX_KAP=y/CONFIG_KNOX_KAP=n/g' $DEFCONFIG
          sed -i 's/CONFIG_LTO_CLANG_THIN=y/CONFIG_LTO_NONE=y/g' $DEFCONFIG
          sed -i 's/CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_NONE=y/g' $DEFCONFIG
          echo "CONFIG_LTO_NONE=y" >> $DEFCONFIG

      - name: Build Kernel (Using Official GKI Script)
        run: |
          # 核心修复 4：进入 build 脚本所在的 kernel_source 目录
          cd kernel_source
          
          # 核心修复 5：赋予所有预编译工具链权限（这是 Bazel 运行的关键）
          chmod +x build_kernel_GKI.sh
          find kernel_platform/tools/ -type f -exec chmod +x {} +
          find kernel_platform/build/ -type f -exec chmod +x {} +
          # 额外赋予内部 bazel 可执行权限
          find kernel_platform/prebuilts/ -type f -name "bazel" -exec chmod +x {} +
          
          # 设置内存与 CPU 限制
          export BAZEL_RAM=6144
          export BAZEL_JOBS=2
          
          # 执行编译
          ./build_kernel_GKI.sh

      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: S24-KSU-Kernel
          # 核心修复 6：修正提取路径。三星 GKI 脚本产物通常在 out 或 dist 目录下
          path: |
            kernel_source/out/**/dist/Image
            kernel_source/out/**/dist/*.ko
