name: s24
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read  # 允许读取 Release

    steps:
      - name: Checkout Script
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          swap-size-mb: 16384

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm python3-pip unzip

      - name: Download and Extract Source
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "正在下载源码..."
          # 下载仓库中所有的压缩包（自动识别 .zip 或 .tar.gz）
          gh release download --repo ${{ github.repository }} --pattern 'Kernel.tar.gz' --clobber
          
          echo "正在解压..."
          mkdir -p kernel_source
          # 自动根据后缀名解压
          if ls *.zip 1> /dev/null 2>&1; then
            unzip -q *.zip -d kernel_source/
          elif ls *.tar.gz 1> /dev/null 2>&1; then
            tar -zxf *.tar.gz -C kernel_source/
          fi
          
          # 检查解压后的层级，确保 kernel_platform 在根部
          if [ -d "kernel_source/kernel_source" ]; then
            mv kernel_source/kernel_source/* kernel_source/
          fi
          ls -F kernel_source/

      - name: Setup KernelSU
        run: |
          # 自动递归寻找 common 目录
          COMMON_PATH=$(find $GITHUB_WORKSPACE/kernel_source -name "common" -type d | grep "kernel_platform/common" | head -n 1)
          if [ -z "$COMMON_PATH" ]; then echo "错误：源码解压后未找到 common 目录"; exit 1; fi
          echo "COMMON_DIR=$COMMON_PATH" >> $GITHUB_ENV
          
          cd "$COMMON_PATH"
          # 补全 KernelSU 官方脚本地址
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
          
          # 修改配置以绕过三星 S24 的 RKP/KDP 检查（2026 关键点）
          DEFCONFIG="arch/arm64/configs/gki_defconfig"
          rm -f android/abi_gki_protected_exports_*
          
          echo "CONFIG_KSU=y" >> $DEFCONFIG
          echo "CONFIG_OVERLAY_FS=y" >> $DEFCONFIG
          sed -i 's/CONFIG_RKP_KDP=y/CONFIG_RKP_KDP=n/g' $DEFCONFIG
          sed -i 's/CONFIG_RKP_NS_PROT=y/CONFIG_RKP_NS_PROT=n/g' $DEFCONFIG
          sed -i 's/CONFIG_KNOX_KAP=y/CONFIG_KNOX_KAP=n/g' $DEFCONFIG
          # 强制 LTO 为 NONE 以防 GitHub 虚拟机内存溢出
          sed -i 's/CONFIG_LTO_CLANG_THIN=y/CONFIG_LTO_NONE=y/g' $DEFCONFIG
          sed -i 's/CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_NONE=y/g' $DEFCONFIG
          echo "CONFIG_LTO_NONE=y" >> $DEFCONFIG

      - name: Build Kernel
        run: |
          # 1. 确定根目录
          PROJECT_ROOT=$(find $GITHUB_WORKSPACE -name "kernel_platform" -printf '%h\n' | head -n 1)
          cd "$PROJECT_ROOT"

          # 2. 创建目录结构
          mkdir -p kernel_platform/prebuilts/clang/host/linux-x86/clang-r487703
          mkdir -p kernel_platform/prebuilts/bazel/linux-x86_64
          mkdir -p kernel_platform/prebuilts/build-tools/path/linux-x86
          
          # 3. 修复 Clang 下载逻辑 (使用更可靠的镜像源或重试逻辑)
          echo "正在下载 Google Clang r487703..."
          # 使用 -L 跟踪重定向，并添加重试
          curl -fSL --retry 3 "https://android.googlesource.com" -o clang.tar.gz
          
          # 检查文件是否为真正的 gzip (防止下载到 HTML)
          if file clang.tar.gz | grep -q "gzip compressed data"; then
             tar -C kernel_platform/prebuilts/clang/host/linux-x86/clang-r487703 -zxf clang.tar.gz
          else
             echo "下载失败：文件不是有效的 gzip 格式。尝试使用备用 CDN 下载..."
             # 如果 Google 源失败，尝试通过 AOSP 预编译仓库的原始链接下载（示例，2026年有效地址）
             curl -fSL "https://android.googlesource.com" -o clang.tar.gz
             tar -C kernel_platform/prebuilts/clang/host/linux-x86/clang-r487703 -zxf clang.tar.gz
          fi

          # 4. 下载并部署 Bazel
          curl -fSL "https://github.com" -o kernel_platform/prebuilts/bazel/linux-x86_64/bazel
          chmod +x kernel_platform/prebuilts/bazel/linux-x86_64/bazel
          
          # 5. 修复 Python 链接
          ln -sf $(which python3) kernel_platform/prebuilts/build-tools/path/linux-x86/python3

          # 6. 设置 README 指定的环境变量
          export BUILD_TARGET=e1q_chn_openx
          export MODEL=e1q
          export CHIPSET_NAME=pineapple
          export ANDROID_BUILD_TOP=$(pwd)
          export TARGET_PRODUCT=gki
          export TARGET_BOARD_PLATFORM=gki
          export OUT_DIR=${ANDROID_BUILD_TOP}/out/msm-kernel-${CHIPSET_NAME}-${TARGET_PRODUCT}
          
          # 将工具链加入 PATH
          export PATH=$ANDROID_BUILD_TOP/kernel_platform/prebuilts/bazel/linux-x86_64:$PATH
          export PATH=$ANDROID_BUILD_TOP/kernel_platform/prebuilts/build-tools/path/linux-x86:$PATH

          # 7. 执行编译
          # 如果 README 要求的 prepare_vendor.sh 失败，由于源码不全，建议回退到 build_kernel_GKI.sh
          chmod +x ./kernel_platform/build/android/prepare_vendor.sh
          chmod +x ./build_kernel_GKI.sh
          
          echo "尝试执行 prepare_vendor.sh..."
          RECOMPILE_KERNEL=1 ./kernel_platform/build/android/prepare_vendor.sh sec ${TARGET_PRODUCT} || \
          (echo "prepare_vendor 失败，可能缺少驱动源码，尝试 GKI 核心编译..." && yes y | ./build_kernel_GKI.sh)


      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: S24-Kernel-Output
          path: |
            kernel_source/out/**/boot/Image
            kernel_source/out/**/*.ko

      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: S24-KSU-Kernel-$(date +%Y%m%d)
          path: |
            kernel_source/out/**/dist/Image
            kernel_source/out/**/dist/*.ko
