name: s24
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          swap-size-mb: 16384

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm python3-pip

      - name: Debug Path
        run: |
          echo "当前工作目录内容："
          ls -F
          echo "-------------------"
          # 自动寻找包含 build_kernel_GKI.sh 的目录并设为工作目录
          BUILD_ROOT=$(find . -name "build_kernel_GKI.sh" -printf '%h\n' | head -n 1)
          echo "BUILD_ROOT=$BUILD_ROOT" >> $GITHUB_ENV

      - name: Setup KernelSU and Patch Source
        run: |
          # 自动定位 common 目录
          COMMON_PATH=$(find . -name "common" -type d | grep "kernel_platform/common" | head -n 1)
          if [ -z "$COMMON_PATH" ]; then echo "错误：找不到 common 目录"; exit 1; fi
          
          cd "$COMMON_PATH"
          # 注入 KernelSU
          curl -LSs "https://raw.githubusercontent.com" | bash -
          
          # 物理删除 ABI 限制（GKI 强制要求）
          rm -f android/abi_gki_protected_exports_*
          
          # 修改 GKI 配置文件
          DEFCONFIG="arch/arm64/configs/gki_defconfig"
          echo "CONFIG_KSU=y" >> $DEFCONFIG
          echo "CONFIG_OVERLAY_FS=y" >> $DEFCONFIG
          # 针对三星 S24 的关键补丁：禁用 RKP 和安全检查，否则无法开机
          sed -i 's/CONFIG_RKP_KDP=y/CONFIG_RKP_KDP=n/g' $DEFCONFIG
          sed -i 's/CONFIG_RKP_NS_PROT=y/CONFIG_RKP_NS_PROT=n/g' $DEFCONFIG
          sed -i 's/CONFIG_KNOX_KAP=y/CONFIG_KNOX_KAP=n/g' $DEFCONFIG
          sed -i 's/CONFIG_LTO_CLANG_THIN=y/CONFIG_LTO_NONE=y/g' $DEFCONFIG
          sed -i 's/CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_NONE=y/g' $DEFCONFIG
          echo "CONFIG_LTO_NONE=y" >> $DEFCONFIG

      - name: Build Kernel
        run: |
          # 使用之前 Debug 出来的路径
          cd ${{ env.BUILD_ROOT }}
          
          # 赋予权限（极其关键：解决 Permission Denied）
          chmod +x build_kernel_GKI.sh
          # 递归赋予所有编译相关的 bin/tools 执行权限
          find kernel_platform -type f -path "*/bin/*" -exec chmod +x {} +
          find kernel_platform -type f -name "bazel*" -exec chmod +x {} +
          find kernel_platform/build -type f -exec chmod +x {} +
          
          # 设置内存与核心限制，防止 GitHub 强制关闭任务
          export BAZEL_RAM=6144
          export BAZEL_JOBS=2
          
          # 运行构建脚本
          ./build_kernel_GKI.sh

      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: S24-KSU-Kernel-Image
          # 路径使用通配符以适应不同的构建变体
          path: |
            **/out/**/dist/Image
            **/out/**/dist/*.ko

