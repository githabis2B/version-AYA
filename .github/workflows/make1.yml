name: make1
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read

    steps:
      - name: Checkout Script
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          swap-size-mb: 16384

      - name: Set up Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison m4 libssl-dev libelf-dev p7zip-full gzip
          
          
      - name: 准备源码与工具链
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 1. 下载并解压源码
          echo "正在下载源码..."
          gh release download kernel --repo ${{ github.repository }} --pattern 'Kernel.tar.gz' --clobber
          
          mkdir -p kernel_source
          echo "正在解压源码..."
          tar -zxf Kernel.tar.gz -C kernel_source/ --strip-components=1
          rm Kernel.tar.gz

          # 2. 进入源码目录准备下载工具链
          # 这样可以确保 gh 下载的文件直接就在 kernel_source 目录下
          cd kernel_source
          mkdir -p kernel_platform/prebuilts

          echo "正在下载工具链分卷..."
          gh release download S24_Tools --repo ${{ github.repository }} -p 'toolchain.tar.tar.*' --clobber
          
          echo "正在流式合并解压工具链..."
          # 注意：此时已在 kernel_source 目录下，所以 -C 路径不需要加前缀
          7z x -so toolchain.tar.tar.001 | tar -xzf - -C kernel_platform/prebuilts/ --strip-components=1
          
          echo "清理临时文件..."
          rm toolchain.tar.tar.*


      - name: Setup KernelSU and Security Patches
        run: |
          COMMON_PATH=$(find $GITHUB_WORKSPACE/kernel_source -name "common" -type d | grep "kernel_platform/common" | head -n 1)
          cd "$COMMON_PATH"
          # 1. 集成 KernelSU
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -


      - name: 放置自定义配置文件
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 1. 定位内核配置存放的物理目录
          # 注意：必须放在 arch/arm64/configs 下，make 才能识别
          CONFIG_TARGET_DIR="$COMMON_DIR/arch/arm64/configs"
          mkdir -p "$CONFIG_TARGET_DIR"

          echo "正在从 Release [defconfig] 下载文本配置文件..."
          # 下载匹配模式的文件
          gh release download defconfig --repo ${{ github.repository }} --pattern 'pineapple_gki_defconfig' --clobber

          # 2. 强制移动并确保命名准确
          # 即使下载下来带了后缀，也强制更名为 make 识别的名字
          mv -f pineapple_gki_defconfig "$CONFIG_TARGET_DIR/pineapple_gki_defconfig"

          echo "✅ 配置文件已就位: $CONFIG_TARGET_DIR/pineapple_gki_defconfig"
          echo "文件行数统计："
          wc -l "$CONFIG_TARGET_DIR/pineapple_gki_defconfig"



      - name: Build Kernel
        run: |
          # 1. 环境变量与路径准备
          CLANG_PATH=$WORKING_DIR/prebuilts/clang/host/linux-x86/clang-r487747c/bin
          BUILD_TOOLS=$WORKING_DIR/prebuilts/build-tools/linux-x86/bin
          export PATH=$CLANG_PATH:$BUILD_TOOLS:$PATH
          
          # 将 LOCALVERSION 整合进 ARGS，确保万无一失
          LOCALVERSION="-android14-11"
          ARGS="ARCH=arm64 LLVM=1 LLVM_IAS=1 CROSS_COMPILE=aarch64-linux-android- CROSS_COMPILE_COMPAT=arm-linux-androideabi- LD=ld.lld LOCALVERSION=$LOCALVERSION"
          
          # 2. 进入核心编译目录
          cd $COMMON_DIR
          chmod +x ./scripts/config

          # 3. 加载 7850 行的“神级配置” 确保 pineapple_gki_defconfig 已在 $COMMON_DIR/arch/arm64/configs/ 下
          make O=$OUT_DIR $ARGS pineapple_gki_defconfig
          # 4. make
          ./scripts/config --file $OUT_DIR/.config \
            -d UH \
            -d RKP \
            -d KDP \
            -d SECURITY_DEFEX \
            -d INTEGRITY \
            -d FIVE \
            -d TRIM_UNUSED_KSYMS \
            -e KSU

          # 5. 同步依赖并开始编译
          # 限制 -j2 以防 GitHub Actions 内存溢出 (OOM)
          make O=$OUT_DIR $ARGS olddefconfig
          make -j2 O=$OUT_DIR $ARGS Image

          
          
      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: S24-Kernel-Image
          path: out/arch/arm64/boot/Image
