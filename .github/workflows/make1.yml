name: make1
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read

    steps:
      - name: Checkout Script
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          swap-size-mb: 16384

      - name: Set up Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison m4 libssl-dev libelf-dev p7zip-full gzip dwarves
       #sudo apt-get install -y bc build-essential git bison libncurses5-dev libelf-dev flex libssl-dev p7zip-full lz4 cpio curl 
          
          
      - name: Download and Extract Source
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "正在下载源码..."
          gh release download kernel --repo ${{ github.repository }} --pattern 'Kernel.tar.gz' --clobber
          
          echo "正在解压源码..."
          mkdir -p kernel_source
          if ls *.zip 1> /dev/null 2>&1; then
            unzip -q *.zip -d kernel_source/
          elif ls *.tar.gz 1> /dev/null 2>&1; then
            tar -zxf *.tar.gz -C kernel_source/
          fi
          
          if [ -d "kernel_source/kernel_source" ]; then
            mv kernel_source/kernel_source/* kernel_source/
          fi

      - name: Download and Setup Official Toolchain
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 1. 确定工作根目录
          PROJECT_ROOT=$(find $GITHUB_WORKSPACE/kernel_source -name "kernel_platform" -printf '%h\n' | head -n 1)
          cd "$PROJECT_ROOT"

          echo "正在下载工具链分卷..."
          gh release download S24_Tools --repo ${{ github.repository }} --pattern 'toolchain.tar.tar.*' --clobber

          echo "正在合并并提取分卷 (7z)..."
          # 7z 会直接从 .001 提取出里面的压缩包
          7z x toolchain.tar.tar.001 -y
          
          # 【关键调试步骤】列出当前文件，看看 7z 到底解压出了什么
          echo "检查当前目录下文件："
          ls -lh
          
          # 2. 物理定位解压出来的压缩包 (自动处理命名不一致)
          GZ_FILE=$(ls *.tar.gz 2>/dev/null | head -n 1)
          if [ -z "$GZ_FILE" ]; then
            echo "错误：未发现 .tar.gz 文件，尝试查找 .tar"
            TAR_FILE=$(ls *.tar 2>/dev/null | head -n 1)
          else
            echo "发现压缩包: $GZ_FILE，正在解压缩为 .tar..."
            # 使用 gunzip 保持文件名一致性，这样更节省空间且稳定
            gunzip -f "$GZ_FILE"
            TAR_FILE=$(ls *.tar 2>/dev/null | head -n 1)
          fi

          if [ -z "$TAR_FILE" ]; then
            echo "错误：无法定位到任何 .tar 文件！"
            ls -R
            exit 1
          fi

          echo "最终解压 $TAR_FILE 到 prebuilts..."
          mkdir -p kernel_platform/prebuilts
          # 执行最终解压
          tar -xf "$TAR_FILE" -C kernel_platform/prebuilts/ --strip-components=1

          echo "清理临时大文件..."
          rm -f toolchain.tar.tar.*
          rm -f *.tar
          
          echo "工具链就位！验证路径："
          ls -F kernel_platform/prebuilts/ | head -n 10


      - name: Setup KernelSU and Security Patches
        run: |
          COMMON_PATH=$(find $GITHUB_WORKSPACE/kernel_source -name "common" -type d | grep "kernel_platform/common" | head -n 1)
          cd "$COMMON_PATH"
          # 1. 集成 KernelSU
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -


      - name: Deploy Custom Defconfig
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 1. 动态寻找 common 目录 (这是你的内核主目录)
          COMMON_DIR=$(find $GITHUB_WORKSPACE -name "common" -type d | grep "kernel_platform/common" | head -n 1)
          
          # 2. 检查路径是否存在
          if [ -z "$COMMON_DIR" ]; then echo "❌ 找不到 common 目录"; exit 1; fi
          
          # 3. 下载并部署配置
          CONFIG_TARGET_DIR="$COMMON_DIR/arch/arm64/configs"
          mkdir -p "$CONFIG_TARGET_DIR"
          gh release download defconfig --repo ${{ github.repository }} --pattern 'pineapple_gki_defconfig' --clobber
          mv -f pineapple_gki_defconfig "$CONFIG_TARGET_DIR/pineapple_gki_defconfig"
          
          # 4. 将路径写入全局环境变量，供下一步 Build 使用
          echo "COMMON_DIR=$COMMON_DIR" >> $GITHUB_ENV
          echo "PROJECT_ROOT=$(dirname $COMMON_DIR)" >> $GITHUB_ENV
          echo "OUT_DIR=$(dirname $COMMON_DIR)/out" >> $GITHUB_ENV
          
          echo "✅ 配置就位，行数：$(wc -l < $CONFIG_TARGET_DIR/pineapple_gki_defconfig)"

      - name: Build Kernel
        run: |
          # 这种写法最安全，不会抓错平台
          CLANG_BIN=$(find $PROJECT_ROOT/prebuilts/clang/host/linux-x86 -name "clang" -type f | xargs dirname | head -n 1)
          BUILD_TOOLS=$(find $PROJECT_ROOT/prebuilts/build-tools/linux-x86 -name "make" -type f | xargs dirname | head -n 1)

          
          export PATH="$CLANG_BIN:$BUILD_TOOLS:$PATH"
          
          # 编译参数
          LOCALVERSION="-android14-11"
          ARGS="ARCH=arm64 LLVM=1 LLVM_IAS=1 CROSS_COMPILE=aarch64-linux-android- CROSS_COMPILE_COMPAT=arm-linux-androideabi- LD=ld.lld LOCALVERSION=$LOCALVERSION"
          
          # 2. 开始构建
          cd "$COMMON_DIR"
          mkdir -p "$OUT_DIR"
          chmod +x ./scripts/config

          # 加载配置
          make O="$OUT_DIR" $ARGS pineapple_gki_defconfig
          ./scripts/config --file "$OUT_DIR/.config" \
            -d UH -d FIVE -d PROCA -d SECURITY_DEFEX -d KNOX_NCM \
            -d SECURITY_DSMS -d SECURITY_KUMIHO -d RKP -d KDP -d INTEGRITY \
            -e KSU -e LTO_CLANG_THIN -d LTO_CLANG_FULL -d STACKPROTECTOR \
            -d STACKPROTECTOR_PER_TASK -d STACKPROTECTOR_STRONG -d DEBUG_INFO_BTF
          # 最终编译
          make -j2 O="$OUT_DIR" $ARGS olddefconfig
          make -j2 O="$OUT_DIR" $ARGS Image V=1


      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: S24-Kernel-Image
          # 自动在所有目录下搜索 Image，只要它在 out 路径结构内
          path: "**/out/arch/arm64/boot/Image"

