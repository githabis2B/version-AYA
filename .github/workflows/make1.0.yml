name: make1.0
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read

    steps:
      - name: Checkout Script
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          swap-size-mb: 16384

      - name: Set up Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison m4 libssl-dev libelf-dev p7zip-full gzip





          
      - name: Download and Extract Source
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "正在下载源码..."
          gh release download kernel --repo ${{ github.repository }} --pattern 'Kernel.tar.gz' --clobber
          
          echo "正在解压源码..."
          mkdir -p kernel_source
          if ls *.zip 1> /dev/null 2>&1; then
            unzip -q *.zip -d kernel_source/
          elif ls *.tar.gz 1> /dev/null 2>&1; then
            tar -zxf *.tar.gz -C kernel_source/
          fi
          
          if [ -d "kernel_source/kernel_source" ]; then
            mv kernel_source/kernel_source/* kernel_source/
          fi



      - name: Download and Setup Official Toolchain
        env:
           GH_TOKEN: ${{ github.token }}
        run: |
            # 1. 进入指定目录 (假设路径固定)
            cd "$GITHUB_WORKSPACE/kernel_source"

            # 2. 下载并一步到位解压
            echo "正在下载并自动合并解压..."
            gh release download S24_Tools -p 'toolchain.tar.tar.*' --clobber
    
            # 创建目标目录
            mkdir -p kernel_platform/prebuilts
    
            # 核心：7z 解压分卷直接送入 tar 提取，不产生中间大文件
            7z x -so toolchain.tar.tar.001 | tar -xf - -C kernel_platform/prebuilts/ --strip-components=1
    
            # 3. 清理下载的残余分卷
            rm toolchain.tar.tar.*




      - name: Setup KernelSU and Security Patches
        run: |
          COMMON_PATH=$(find $GITHUB_WORKSPACE/kernel_source -name "common" -type d | grep "kernel_platform/common" | head -n 1)
          cd "$COMMON_PATH"

          # 1. 集成 KernelSU
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -


          # 物理删除 ABI 保护文件
          rm -f android/abi_gki_protected_exports_*


          
      - name: Build Kernel
        run: |
          
          # 1. 精确定义路径
          # 如果你的解压逻辑导致了 kernel_source/kernel_platform/common 的结构：
          WORKING_DIR=$(pwd)/kernel_source/kernel_platform
          COMMON_DIR=$WORKING_DIR/common
          OUT_DIR=$(pwd)/out
          
          # 验证目录是否存在
          if [ ! -d "$COMMON_DIR" ]; then
            echo "错误：找不到 $COMMON_DIR"
            echo "当前全路径文件树预览："
            ls -R $(pwd) | grep ":$" | sed -e 's/:$//' -e 's/[^-][^\/]*\//--/g' -e 's/^/   /'
            exit 1
          fi

          # 2. 工具链路径 (指向你解压确定的位置)
          CLANG_PATH=$WORKING_DIR/prebuilts/clang/host/linux-x86/clang-r487747c/bin
          BUILD_TOOLS=$WORKING_DIR/prebuilts/build-tools/linux-x86/bin
          export PATH=$CLANG_PATH:$BUILD_TOOLS:$PATH
          
          # 3. 环境变量
          export LOCALVERSION="-android14-12-qcom"
          export ARCH=arm64
          export LLVM=1
          export LLVM_IAS=1
          ARGS="ARCH=arm64 LLVM=1 LLVM_IAS=1 CROSS_COMPILE=aarch64-linux-android- CROSS_COMPILE_COMPAT=arm-linux-androideabi- LD=ld.lld"
          
          # 4. 执行编译
          cd $COMMON_DIR
          chmod +x ./scripts/config
          
          make O=$OUT_DIR $ARGS gki_defconfig
          
          # --- 修复核心：禁用 BTF ---
          ./scripts/config --file $OUT_DIR/.config -d DEBUG_INFO_BTF
          
          # 1. 禁用 BTF (解决 pahole 报错)
          ./scripts/config --file $OUT_DIR/.config -d DEBUG_INFO_BTF

          # 2. 彻底禁用栈保护 (解决 __stack_chk_guard 链接报错)
          # 必须同时禁用这三项，确保编译器不再生成相关检查代码
          ./scripts/config --file $OUT_DIR/.config -d STACKPROTECTOR
          ./scripts/config --file $OUT_DIR/.config -d STACKPROTECTOR_STRONG
          ./scripts/config --file $OUT_DIR/.config -d STACKPROTECTOR_PER_TASK

          # 3. 核心：死守 LTO 开启 (这是保证开机的关键，不能动)
          ./scripts/config --file $OUT_DIR/.config -e LTO_CLANG_THIN
          
          # 4. 强制检查 (防止被 olddefconfig 自动回滚)
          make O=$OUT_DIR $ARGS olddefconfig
          # 确保 LTO 开启
          ./scripts/config --file $OUT_DIR/.config -e LTO_CLANG_THIN

          
          make O=$OUT_DIR $ARGS olddefconfig
          make -j$(nproc --all) O=$OUT_DIR $ARGS Image


          
          
      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: S24-Kernel-Image
          path: out/arch/arm64/boot/Image
